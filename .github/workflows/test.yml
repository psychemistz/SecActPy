# =============================================================================
# GitHub Actions: Run Tests
#
# Triggers:
#   - Push to main/develop
#   - Pull requests
# =============================================================================

name: Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false  # Don't cancel other jobs if one fails
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install numpy pandas scipy h5py anndata scanpy
          pip install pytest pytest-cov
          pip install -e .

      - name: Test import
        run: |
          python -c "import secactpy; print(f'SecActPy imported successfully')"
          python -c "from secactpy import ridge, ridge_batch, secact_activity_inference"
          python -c "from secactpy import load_signature, list_signatures"
          python -c "from secactpy import CUPY_AVAILABLE; print(f'GPU available: {CUPY_AVAILABLE}')"

      - name: Test signature loading
        run: |
          python -c "
          from secactpy import load_signature
          sig = load_signature('secact')
          print(f'SecAct signature: {sig.shape}')
          sig = load_signature('cytosig')
          print(f'CytoSig signature: {sig.shape}')
          "

      - name: Test RNG
        run: |
          python -c "
          from secactpy.rng import GSLRNG
          rng = GSLRNG(0)
          perm = rng.permutation(10)
          expected = [9, 2, 4, 0, 5, 7, 3, 6, 1, 8]
          assert list(perm) == expected, f'RNG mismatch: {perm} != {expected}'
          print('GSL RNG test passed')
          "

      - name: Test basic ridge
        run: |
          python -c "
          import numpy as np
          from secactpy import ridge
          
          np.random.seed(42)
          X = np.random.randn(100, 10)
          Y = np.random.randn(100, 5)
          
          result = ridge(X, Y, lambda_=1e5, n_rand=100, seed=0)
          
          assert 'beta' in result
          assert 'se' in result
          assert 'zscore' in result
          assert 'pvalue' in result
          assert result['beta'].shape == (10, 5)
          print('Basic ridge test passed')
          "

  lint:
    runs-on: ubuntu-latest
    continue-on-error: true  # Don't fail the workflow on lint errors
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install linters
        run: |
          pip install ruff black

      - name: Run ruff (check only, report issues)
        run: |
          ruff check secactpy/ --output-format=github || true

      - name: Run black (check only, report issues)
        run: |
          black --check --diff secactpy/ || true
